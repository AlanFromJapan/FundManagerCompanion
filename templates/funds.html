{% extends 'base.html' %}

{% block title %}Funds List{% endblock %}

{% block content %}
<h1>Funds List ({{ pos | length }} funds)  </h1>

<!-- ------------------------------------------------------ Top visuals ------------------------------------------------------ -->
<div class="visual-frame">
<table class="screensplit">
    <tbody>
        <tr>
            <td><span class="total_positions">Total estimated position amount = {{ "{:,.0f}".format(stats['total_positions']) }} å††</span></td>
            <td class="rightalign"><a href="/funds/register" class="button" style="margin-bottom: 1em; display: inline-block;">ðŸŒ± Register New Fund</a></td>
        </tr>
    </tbody>
</table>


<table class="screensplit">
    <tbody>
        <tr>
            <td style="vertical-align: middle; ">
                <!-- ********************************* Histogram holdings *********************************  -->
                <h2>End-of-Month Holdings</h2>
                <canvas id="fundsEOMHistogram" width="400" height="200"></canvas>
                <script>
                    const ctx2 = document.getElementById('fundsEOMHistogram').getContext('2d');
                    const eomChart = new Chart(ctx2, {
                        type: 'bar',
                        data: {
                            labels: [{% for i in eom %}"{{ i.month }}",{% endfor %} ],
                            datasets: [{
                                label: 'Total Holdings (JPY)',
                                data: [{% for i in eom %}{{ i.monthly_amount }},{% endfor %}],
                                backgroundColor: 'rgba(0, 123, 255, 0.5)',
                                borderColor: 'rgba(0, 123, 255, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Total Investments (JPY)',
                                data: [{% for i in inv %}{{ i.running_investment }},{% endfor %}],
                                backgroundColor: 'rgba(40, 167, 69, 0.5)',
                                borderColor: 'rgba(40, 167, 69, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: false,
                            legend: {
                                display: false
                            },
                            tooltips: {
                                callbacks: {
                                    label: function(tooltipItem, data) {
                                    return data['datasets'][0]['data'][tooltipItem['index']].toLocaleString() + ' å††';
                                    },
                                }
                            },
                            scales: {
                                x: {
                                    stacked: false, //overlay instead of stacked
                                },
                                yAxis: {
                                    beginAtZero: true,
                                    ticks: {
                                        // Include a thousands separator in the ticks
                                        callback: function(value, index, values) {
                                            return value.toLocaleString() ;
                                        }
                                    }
                                }
                            }
                        }
                    });
                </script>
            </td>

            <td style="width:300px;">
                <!-- ********************************* Doughnut *********************************  -->
                <canvas id="fundsDonutChart" width="300" height="200"></canvas>
                <script>
                    //OceanBreeze palette from Coolors (thank you!)
                const palette = ['#03045E', '#0077B6', '#00B4D8', '#90E0EF', '#CAF0F8'];
                const ctx = document.getElementById('fundsDonutChart').getContext('2d');
                const zaChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ["{{ pos | map(attribute='name') | join('", "') | safe }}"],
                        datasets: [{
                            data: [{{ pos | map(attribute='portfolio_holding_contrib_pct')  | join(', ') | safe }}],
                            backgroundColor: palette,
                        }]
                    },
                    options: {
                        responsive: false,
                        legend: {
                            display: false
                        },
                        tooltips: {
                            callbacks: {
                                title: function(tooltipItem, data) {
                                return data['labels'][tooltipItem[0]['index']];
                                },
                                label: function(tooltipItem, data) {
                                return data['datasets'][0]['data'][tooltipItem['index']] + '% of portfolio';
                                },
                            }
                        }
                    }, 
                    plugins: [
                        {
                            beforeDraw: function(chart) {
                                var ctx = chart.chart.ctx;
                                ctx.save();
                                var image = new Image();      
                                image.src = '/favicon.png';      
                                imageSize = 64;
                                ctx.drawImage(image, chart.chart.width / 2 - imageSize / 2, chart.chart.height / 2 - imageSize / 2, imageSize, imageSize);
                                ctx.restore();
                            }
                        }
                    ]
                });
                </script>
            </td>
        </tr>
    </tbody>
</table>
</div>

<!-- ------------------------------------------------------ Fund Table ------------------------------------------------------ -->

<table class="funds_table" id="funds_table">
        <tr>
            <th>Name <button onclick="selectTable()">Select Table</button><button onclick="copyPrompt()">Prompt</button></th>
            <th>%</th>
            <th>Current shares</th>
            <th>Current amount</th>
            <th>Latest NAV<br/>Î”NAV</th>
            <th class="tooltip">6M Total Return%
                <span class="tooltiptext">6 Months Total Return Percentage (NAV difference including received dividends)</span>
            </th>
            <th class="tooltip">1Y Total Return%
                <span class="tooltiptext">1 Year Total Return Percentage (NAV difference including received dividends)</span>
            </th>
        </tr>
    {% for p in pos %}
    {% set impact_threshold = 10 %}
    {% set ytd_warning_threshold = 100 * conf.target_yearly_rate %}
    <tr>
        <td id="td{{ p['fund_id'] }}" class="fund_header {{ 'impact' if p['portfolio_holding_contrib_pct'] >= impact_threshold else '' }}"><a href="/funds/{{ p['fund_id'] }}">[{{ p["fund_id"] }}] {{ p["name"] }}</a></td>
        <td class="centeralign {{ 'impact' if p['portfolio_holding_contrib_pct'] >= impact_threshold else '' }}">{{ "{:,.0f}%".format(p["portfolio_holding_contrib_pct"]) }}</td>
        <td class="rightalign">{{ "{:,.0f}".format(p["latest_unit"]) }}</td>
        <td class="rightalign">{{ "{:,.0f}".format(p["latest_unit"] * p["latest_nav"] / 10000.0 ) }}&nbsp;å††</td>
        <td class="rightalign">{{ "{:,.0f}".format(p["latest_nav"]) }}<br/><span class="rightalign {{ 'stat_positive' if p['daily_change_nav'] > 0 else 'stat_negative' if p['daily_change_nav'] < 0 else '' }}">{{ "{:+,.0f}".format(p['daily_change_nav']) }}</span></td>
        <td class="rightalign unbreakable {{ 'stat_positive' if p['total_return_6m'] > ytd_warning_threshold else 'stat_negative' if p['total_return_6m'] < 0 else 'stat_warning' }}">{{ "{:+,.2f}%".format(p["total_return_6m"]) }} {{ "ðŸš€" if p['perf_evolution'] < 0 else ""  }}</td>
        <td class="rightalign {{ 'stat_positive' if p['total_return_12m'] > ytd_warning_threshold else 'stat_negative' if p['total_return_12m'] < 0 else 'stat_warning' }}">{{ "{:+,.2f}%".format(p["total_return_12m"]) }}</td>
    </tr>
    {% endfor %}
</table>
<script lang="javascript">
    //Paint the row with color of the doughnut
    let cnt = 0;
    for (const p of [{{ pos | map(attribute='fund_id') | join(', ') | safe }}]) {
        const td = document.getElementById(`td${p}`);
        // Use the palette colors for each fund ID (works because the palette is defined above and the funds are in the highest contribution order desc)
        if (cnt < palette.length) {
            td.style.backgroundColor = palette[cnt];
        }
        cnt ++;
    }
</script>
<details>
    <summary>Fund NAV refresh actions (click to unfold)</summary>
    <form method="post" action="/funds">
        <input type="hidden" name="update_nav" value="true">
        <input type="submit" value="Update ALL funds latest NAV">
    </form>
    <form method="post" action="/funds">
        <input type="hidden" name="update_history_nav" value="true">
        <input type="submit" value="Update ALL funds HISTORICAL NAV">
    </form>
    <form method="post" action="/funds">
        <input type="hidden" name="update_whole_nav" value="true">
        <input type="submit" value="Update ALL funds WHOLE NAV from Investment Trust Association">
    </form>
</details>


<script>
function selectTable() {
  const table = document.querySelector('#funds_table');
  if (window.getSelection && document.createRange) {
    const range = document.createRange();
    range.selectNode(table);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
  }
}

function copyPrompt(){
    let promptText = "Below is a table with the name of the funds I invested in. Ignore the number between brackets in the name. Second column is the percentage of the whole portfolio. What can you tell me about my investment, and what would be your next suggestion of investment?";

    navigator.clipboard.writeText(promptText).then(function() {
        alert('Prompt copied to clipboard!');
    }, function(err) {
        alert('Could not copy text: ', err);
    });
}
</script>
{% endblock %}

    
