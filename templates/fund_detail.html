{% extends 'base.html' %}

{% block title %}Funds Detail{% endblock %}

{% block content %}
<h2>Fund Details</h2>
<table>
    <tr>
        <td>Fund UID</td>
        <td colspan="2">{{ fund.fund_id }}</td>
    </tr>
    <tr>
        <td>Name</td>
        <td colspan="2">{{ fund.name }}</td>
    </tr>
    <tr>
        <td>Currency</td>
        <td colspan="2">{{ fund.currency }}</td>
    </tr>
    <tr>
        <td>Codes</td>
        <td>
            {% if fund.codes %}
                <ul>
                    {% for code, value in fund.codes.items() %}
                        <li>{{ code }}: <code>{{ value }}</code></li>
                    {% endfor %}
                </ul>
            {% else %}
                No codes available
            {% endif %}
        </td>
        <td>
            <ul>
                <li><a href="https://fund.monex.co.jp/detail/{{fund.codes['yahoo_finance']}}" target="_blank">MONEX site</a></li>
                <li><a href="https://finance.yahoo.co.jp/quote/{{fund.codes['yahoo_finance']}}" target="_blank">Yahoo Finance</a></li>
                <li><a href="https://toushin-lib.fwg.ne.jp/FdsWeb/FDST030000?isinCd={{fund.codes['ISIN']}}" target="_blank">Toushin Lib （投資信託協会）</a></li>
            </ul>
        </td>
    </tr>
</table>

<form method="post" action="/funds/{{ fund.fund_id }}">
    <input type="hidden" name="update_nav" value="true">
    <input type="submit" value="Update NAV">
</form>
<form method="post" action="/funds/{{ fund.fund_id }}">
    <input type="hidden" name="update_history_nav" value="true">
    <input type="submit" value="Update HISTORICAL NAV">
</form>

{% if fund.nav %}
    <h3>NAV Chart</h3>
    <canvas id="myChart" ></canvas>

<script>

    const myLabels = JSON.parse('{{ chartData[1] | tojson | safe }}');
    const myValues = JSON.parse('{{ chartData[0] | tojson | safe }}');

    const data = {
        labels: myLabels,
        datasets: [{
            borderColor: 'rgb(75, 192, 192)',
            label: '{{ fund.name }}',
            tension: 0.0,
            data: myValues,
        }]
    };

    const config = {
        type: 'line',
        data: data,
        options: {
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day',
                    },
                },

            },
        }
    };

    const myChart = new Chart(
        document.getElementById('myChart'),
        config
    );
</script>

    <!--   --------------------------------------------------------------------------- -->

    <h3>Latest NAV</h3>
    <table>
        <tr>
            <th>Date</th>
            <th>NAV</th>
            <th>NAV Diff (Value)</th>
            <th>NAV Diff (%)</th>
        </tr>
        {% for ni in range(0, fund.nav_sorted|length) %}
        <tr>
            <td>{{ fund.nav_sorted[ni][0][:10] }}</td>
            <td>{{ "{:,.0f}".format(fund.nav_sorted[ni][1]) }}</td>
            <td>
                {% if fund.nav_diff  and ni < fund.nav_diff|length %}
                    {{ "{:+,.0f}".format(fund.nav_diff[ni].diffamt) }}
                {% else %}
                    N/A
                {% endif %}
            <td>
                {% if fund.nav_diff  and ni < fund.nav_diff|length %}
                    {{ "{:+,.2f}".format(fund.nav_diff[ni].diffpct) }}
                {% else %}
                    N/A
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>


{% else %}
    No NAV data available.
{% endif %}

<h3>Transactions</h3>
{% if fund.transactions %}
    {{ xact_table(fund.transactions, {'show_fund': False, 'fundname': fund.name}) }}
{% else %}
    No transactions available.
{% endif %}

{% endblock %}

    
